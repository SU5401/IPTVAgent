#!/bin/bash
. ./insert
recordTime=`date -d today +"%Y-%m-%d %H:%M:%S"`
# Get the total CPU statistics, discarding the 'cpu ' prefix.
CPU=(`sed -n 's/^cpu\s//p' /proc/stat`)
# Calculate the total CPU time.
TOTAL=0
for VALUE in "${CPU[@]}"; 
  do
    let "TOTAL=$TOTAL+$VALUE"
  done
idleTime=`echo "scale=4;${CPU[3]}/$TOTAL*100"|bc | awk '{printf "%.2f", $0}'` 
user=`echo "scale=4;${CPU[0]}/$TOTAL*100"|bc | awk '{printf "%.2f", $0}'` 
system=`echo "scale=4;${CPU[2]} /$TOTAL*100"|bc | awk '{printf "%.2f", $0}'` 
wait=`echo "scale=4;${CPU[4]}/$TOTAL*100"|bc| awk '{printf "%.2f", $0}'`
hardIrq=`echo "scale=4;${CPU[5]}/$TOTAL*100"|bc| awk '{printf "%.2f", $0}'`
softIrq=`echo "scale=4;${CPU[6]}/$TOTAL*100"|bc| awk '{printf "%.2f", $0}'`
nice=`echo "scale=4;${CPU[1]}/$TOTAL*100"|bc| awk '{printf "%.2f", $0}'`
steal=`echo "scale=4;${CPU[7]}/$TOTAL*100"|bc| awk '{printf "%.2f", $0}'`
guest=`echo "scale=4;${CPU[8]}/$TOTAL*100"|bc| awk '{printf "%.2f", $0}'`
utilize=`echo "scale=4;(1-${CPU[3]}/$TOTAL-${CPU[4]}/$TOTAL-${CPU[7]}/$TOTAL)*100"|bc| awk '{printf "%.2f", $0}'`
ncpu=`echo $(cat /proc/stat|grep ^cpu -c)`
let "ncpu-=1"
SQLINSERT="insert into cpu(user,system,wait,hardIrq,softIrq,nice,steal,guest,utilize,ncpu,idle,recordTime,server) values($user,$system,$wait,$hardIrq,$softIrq,$nice,$steal,$guest,$utilize,$ncpu,$idleTime,\"$recordTime\",4);"
echo $SQLINSERT
insert $SQLINSERT


